# Eleanor L Axson, Jennifer K Quint, 2023.

import sys, csv, re

codes = [{"code":"13Y4.00","system":"readv2"},{"code":"14B4.00","system":"readv2"},{"code":"173c.00","system":"readv2"},{"code":"173d.00","system":"readv2"},{"code":"1O2..00","system":"readv2"},{"code":"663V.00","system":"readv2"},{"code":"663V000","system":"readv2"},{"code":"663V100","system":"readv2"},{"code":"663V200","system":"readv2"},{"code":"663h.00","system":"readv2"},{"code":"663j.00","system":"readv2"},{"code":"66YK.00","system":"readv2"},{"code":"8791.00","system":"readv2"},{"code":"H33..00","system":"readv2"},{"code":"H33..11","system":"readv2"},{"code":"H331.11","system":"readv2"},{"code":"H332.00","system":"readv2"},{"code":"H334.00","system":"readv2"},{"code":"H33z.00","system":"readv2"},{"code":"H33z000","system":"readv2"},{"code":"H33z200","system":"readv2"},{"code":"H33zz00","system":"readv2"},{"code":"H35y700","system":"readv2"},{"code":"H47y000","system":"readv2"},{"code":"10692761000119107","system":"snomedct"},{"code":"1086701000000102","system":"snomedct"},{"code":"1086711000000100","system":"snomedct"},{"code":"12428000","system":"snomedct"},{"code":"161105008","system":"snomedct"},{"code":"161527007","system":"snomedct"},{"code":"170627008","system":"snomedct"},{"code":"170631002","system":"snomedct"},{"code":"170632009","system":"snomedct"},{"code":"170633004","system":"snomedct"},{"code":"170634005","system":"snomedct"},{"code":"170635006","system":"snomedct"},{"code":"170636007","system":"snomedct"},{"code":"170637003","system":"snomedct"},{"code":"170638008","system":"snomedct"},{"code":"170642006","system":"snomedct"},{"code":"170647000","system":"snomedct"},{"code":"170655007","system":"snomedct"},{"code":"170656008","system":"snomedct"},{"code":"170657004","system":"snomedct"},{"code":"170658009","system":"snomedct"},{"code":"182724005","system":"snomedct"},{"code":"182726007","system":"snomedct"},{"code":"182727003","system":"snomedct"},{"code":"182728008","system":"snomedct"},{"code":"182729000","system":"snomedct"},{"code":"182730005","system":"snomedct"},{"code":"182731009","system":"snomedct"},{"code":"183099005","system":"snomedct"},{"code":"183478001","system":"snomedct"},{"code":"185242005","system":"snomedct"},{"code":"185728001","system":"snomedct"},{"code":"185730004","system":"snomedct"},{"code":"185731000","system":"snomedct"},{"code":"185732007","system":"snomedct"},{"code":"185734008","system":"snomedct"},{"code":"185735009","system":"snomedct"},{"code":"185736005","system":"snomedct"},{"code":"185940009","system":"snomedct"},{"code":"195949008","system":"snomedct"},{"code":"195967001","system":"snomedct"},{"code":"195977004","system":"snomedct"},{"code":"198971000000102","system":"snomedct"},{"code":"201031000000108","system":"snomedct"},{"code":"201041000000104","system":"snomedct"},{"code":"201051000000101","system":"snomedct"},{"code":"201191000000108","system":"snomedct"},{"code":"201201000000105","system":"snomedct"},{"code":"201211000000107","system":"snomedct"},{"code":"225057002","system":"snomedct"},{"code":"23315001","system":"snomedct"},{"code":"233678006","system":"snomedct"},{"code":"233679003","system":"snomedct"},{"code":"233683003","system":"snomedct"},{"code":"266361008","system":"snomedct"},{"code":"270442000","system":"snomedct"},{"code":"275908000","system":"snomedct"},{"code":"302331000000106","system":"snomedct"},{"code":"312453004","system":"snomedct"},{"code":"312454005","system":"snomedct"},{"code":"31387002","system":"snomedct"},{"code":"340891000000106","system":"snomedct"},{"code":"340901000000107","system":"snomedct"},{"code":"340911000000109","system":"snomedct"},{"code":"340921000000103","system":"snomedct"},{"code":"340931000000101","system":"snomedct"},{"code":"366874008","system":"snomedct"},{"code":"370202007","system":"snomedct"},{"code":"370203002","system":"snomedct"},{"code":"370204008","system":"snomedct"},{"code":"370205009","system":"snomedct"},{"code":"370206005","system":"snomedct"},{"code":"370207001","system":"snomedct"},{"code":"370208006","system":"snomedct"},{"code":"370218001","system":"snomedct"},{"code":"370219009","system":"snomedct"},{"code":"370220003","system":"snomedct"},{"code":"370221004","system":"snomedct"},{"code":"370225008","system":"snomedct"},{"code":"370226009","system":"snomedct"},{"code":"373899003","system":"snomedct"},{"code":"389145006","system":"snomedct"},{"code":"390872009","system":"snomedct"},{"code":"390877003","system":"snomedct"},{"code":"390878008","system":"snomedct"},{"code":"390921001","system":"snomedct"},{"code":"390940007","system":"snomedct"},{"code":"394700004","system":"snomedct"},{"code":"394701000","system":"snomedct"},{"code":"394720003","system":"snomedct"},{"code":"395022009","system":"snomedct"},{"code":"400987003","system":"snomedct"},{"code":"401135008","system":"snomedct"},{"code":"401182001","system":"snomedct"},{"code":"401183006","system":"snomedct"},{"code":"401193004","system":"snomedct"},{"code":"406162001","system":"snomedct"},{"code":"407674008","system":"snomedct"},{"code":"415265005","system":"snomedct"},{"code":"41553006","system":"snomedct"},{"code":"424643009","system":"snomedct"},{"code":"443117005","system":"snomedct"},{"code":"448003001","system":"snomedct"},{"code":"473391009","system":"snomedct"},{"code":"527171000000103","system":"snomedct"},{"code":"527191000000104","system":"snomedct"},{"code":"527211000000100","system":"snomedct"},{"code":"527231000000108","system":"snomedct"},{"code":"56968009","system":"snomedct"},{"code":"57607007","system":"snomedct"},{"code":"63088003","system":"snomedct"},{"code":"698509001","system":"snomedct"},{"code":"708038006","system":"snomedct"},{"code":"708090002","system":"snomedct"},{"code":"708093000","system":"snomedct"},{"code":"708094006","system":"snomedct"},{"code":"708358003","system":"snomedct"},{"code":"708373002","system":"snomedct"},{"code":"713701000000108","system":"snomedct"},{"code":"713711000000105","system":"snomedct"},{"code":"715191006","system":"snomedct"},{"code":"715801000000103","system":"snomedct"},{"code":"716491000000100","system":"snomedct"},{"code":"717291000000103","system":"snomedct"},{"code":"734904007","system":"snomedct"},{"code":"736056000","system":"snomedct"},{"code":"754061000000100","system":"snomedct"},{"code":"763077003","system":"snomedct"},{"code":"763221007","system":"snomedct"},{"code":"763695004","system":"snomedct"},{"code":"771901000000100","system":"snomedct"},{"code":"771941000000102","system":"snomedct"},{"code":"771981000000105","system":"snomedct"},{"code":"772011000000107","system":"snomedct"},{"code":"772051000000106","system":"snomedct"},{"code":"791401000000104","system":"snomedct"},{"code":"810901000000102","system":"snomedct"},{"code":"811151000000105","system":"snomedct"},{"code":"811921000000103","system":"snomedct"},{"code":"866881000000101","system":"snomedct"},{"code":"892301000000100","system":"snomedct"},{"code":"89581000000109","system":"snomedct"},{"code":"905301000103","system":"snomedct"},{"code":"928451000000107","system":"snomedct"},{"code":"92851000000107","system":"snomedct"},{"code":"959401000000101","system":"snomedct"},{"code":"959421000000105","system":"snomedct"},{"code":"959441000000103","system":"snomedct"},{"code":"966011000000109","system":"snomedct"},{"code":"966031000000101","system":"snomedct"},{"code":"1111","system":"ukbiobank"}];
REQUIRED_CODES = 1;
with open(sys.argv[1], 'r') as file_in, open('asthma-potential-cases.csv', 'w', newline='') as file_out:
    csv_reader = csv.DictReader(file_in)
    csv_writer = csv.DictWriter(file_out, csv_reader.fieldnames + ["asthma---primary-identified"])
    csv_writer.writeheader();
    codes_identified = 0;
    for row in csv_reader:
        newRow = row.copy();
        for cell in row:
            # Iterate cell lists (e.g. codes)
            for item in re.findall(r'\(([^,]*)\,', row[cell]):
                if(item in list(map(lambda code: code['code'], codes))): codes_identified+=1;
                if(codes_identified>=REQUIRED_CODES):
                    newRow["asthma---primary-identified"] = "CASE";
                    break;
            if(codes_identified>=REQUIRED_CODES): break;
        if(codes_identified<REQUIRED_CODES):
            newRow["asthma---primary-identified"] = "UNK";
        codes_identified=0;
        csv_writer.writerow(newRow)
